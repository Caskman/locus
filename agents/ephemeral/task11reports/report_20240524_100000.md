# Report: Analysis of Admin Upgrade Plan

**File:** `agents/ephemeral/phase1-onboarding/11-admin-upgrade-plan.md`
**Timestamp:** 2024-05-24 10:00:00

## Executive Summary
The proposed plan for Task 11 ("Admin Upgrade") contains critical functional gaps related to the AWS CloudFormation lifecycle and data persistence. Specifically, the plan relies on re-provisioning logic that only supports "Create Stack" operations, which will fail when attempting to upgrade an existing stack. Furthermore, it lacks the necessary persistence for the `deviceName` identifier, which is required to reconstruct the stack name for any update operations.

## Detailed Findings

### 1. Missing Support for Stack Updates (Critical)
**Analysis:**
The plan directs the reuse of `StackProvisioningService.createAndPollStack` via an updated `ProvisioningUseCase`.
However, analysis of `core/domain/src/main/kotlin/com/locus/core/domain/infrastructure/StackProvisioningService.kt` and `core/data/src/main/kotlin/com/locus/core/data/infrastructure/CloudFormationClientImpl.kt` reveals that the current implementation only supports `CreateStack`.
AWS CloudFormation's `CreateStack` API throws an error if a stack with the same name already exists. Since an "Admin Upgrade" targets an existing user (and thus an existing stack `locus-user-<deviceName>`), this operation will fail immediately.
To successfully upgrade a user's permissions while preserving their S3 bucket (as required by R1.2400 to maintain history), the system must use `UpdateStack`. Creating a new stack with a new name would result in a new S3 bucket, severing the link to historical data.

**Proposed Resolution:**
*   Extend `CloudFormationClient` (interface and impl) to support `updateStack`.
*   Extend `StackProvisioningService` to support `updateAndPollStack`.
*   The `updateStack` implementation must handle the `UpdateStackRequest` and standard CloudFormation behavior (e.g., handling "No updates are to be performed" as a success state).

**Justification:**
This is a hard blocker. Without `UpdateStack` support, the upgrade feature is functionally impossible without deleting the user's data first, which violates data preservation requirements.

### 2. Missing `deviceName` Persistence (Blocking)
**Analysis:**
To perform a stack update (or even a delete/re-create), the system must know the Stack Name. The Stack Name is constructed as `locus-user-<deviceName>`.
Currently, `ProvisioningUseCase` accepts `deviceName` as input from the user during initial setup. However, `RuntimeCredentials` (the persistent auth state) **does not store** the `deviceName`. It only stores the `bucketName` and `accountId`.
The plan assumes `ProvisioningUseCase` can be reused, but it requires `deviceName` as an argument. The "Admin Upgrade" UI flow (Step 8) does not ask the user for their Device Name again (nor should it, for UX reasons).
Without persisting `deviceName`, the system cannot reconstruct the Stack Name to target the correct AWS resource for the upgrade.

**Proposed Resolution:**
*   Modify `RuntimeCredentials` (Domain) and `RuntimeCredentialsDto` (Data) to include a `deviceName: String` property.
*   Update `AuthRepositoryImpl` to persist this value during the initial provisioning.
*   Update `ProvisioningUseCase` to save the `deviceName` when promoting credentials.

**Justification:**
Without the `deviceName`, the system effectively loses the "handle" to the CloudFormation stack after initial creation. This prevents any future infrastructure management operations (Upgrade, Teardown, Recovery).

### 3. Inappropriate Reuse of `ProvisioningUseCase` (Architectural)
**Analysis:**
The plan suggests overloading `ProvisioningUseCase` with an `isAdmin` flag.
`ProvisioningUseCase` is currently tightly coupled to "New Device" logic:
1.  It validates the `deviceName` against a regex.
2.  It generates a **new** `deviceId` UUID.
3.  It generates a **new** Telemetry Salt.
4.  It calls `configRepository.initializeIdentity`.

Reuse for an upgrade is dangerous because:
*   It would generate a new Device ID, causing a "Split Brain" in the local database vs. remote S3 path.
*   It would reset the Telemetry Salt.
*   It re-runs validation logic meant for new inputs.

**Proposed Resolution:**
*   Create a dedicated `UpgradeAccountUseCase`.
*   This Use Case should:
    1.  Retrieve the existing `deviceName` and `RuntimeCredentials`.
    2.  Load the `locus-admin.yaml` template.
    3.  Call `stackProvisioningService.updateAndPollStack`.
    4.  Update the stored `RuntimeCredentials` with the new keys and `isAdmin=true` flag, **preserving** the existing `deviceId` and `telemetrySalt`.

**Justification:**
Separation of concerns. "New Device Provisioning" and "Infrastructure Upgrade" are distinct lifecycles with different invariants. Mixing them risks data corruption (identity reset) and introduces fragile conditional logic.

### 4. Ambiguity in Admin Stack Naming
**Analysis:**
The plan mentions creating `locus-admin.yaml` but does not specify if the stack name changes.
If the stack name changes (e.g., to `locus-admin-<deviceName>`), we abandon the old stack (orphaned resources).
If we keep the same name (`locus-user-<deviceName>`), we are performing an in-place update.
The plan implies an update (R1.2300 "replace existing Runtime Keys"), but doesn't explicitly define the strategy.

**Proposed Resolution:**
*   Explicitly define the strategy as an **In-Place Update** of the existing stack `locus-user-<deviceName>`.
*   Ensure `locus-admin.yaml` uses the same Logical IDs for persistent resources (specifically the S3 Bucket) to ensure CloudFormation preserves them during the update.

**Justification:**
Clarifies the deployment strategy and ensures data safety.

## Revised Plan Recommendations
The plan should be rewritten to:
1.  **Phase 1 (Data):** Add `deviceName` to `RuntimeCredentials` schema and migration.
2.  **Phase 2 (Infra):** Implement `UpdateStack` capability in AWS clients and Services.
3.  **Phase 3 (Domain):** Implement `UpgradeAccountUseCase` instead of modifying `ProvisioningUseCase`.
4.  **Phase 4 (UI):** Build the UI on top of this robust foundation.
