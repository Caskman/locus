# Gap Analysis: Permissions & Setup Trap (Task 10)

**Analyzed Plan:** `agents/ephemeral/phase1-onboarding/10-permissions-setup-trap-plan.md`
**Timestamp:** 20260104_225211

## Findings

### 1. Architectural Violation: ViewModel Permission Checking
The plan specifies "Lifecycle: Observe ON_RESUME to trigger viewModel.checkPermissions()". ViewModels should not have access to the `Context` required to check permissions (`ContextCompat.checkSelfPermission`), as this leaks Android framework dependencies into the ViewModel.
-   **Problem:** The plan implies the ViewModel performs the check directly.
-   **Resolution:** The logic must be split: The UI (Composable/Activity) performs the check (via `checkSelfPermission` or Launcher results) and passes the result (a map of permissions to status) to `viewModel.updatePermissions(permissionsMap)`. The ViewModel then derives the `PermissionUiState`.

### 2. Missing "Coarse Rejection" UI Detail
The plan mandates "Enforce ACCESS_FINE_LOCATION. Treat Coarse Only as a denial". However, the current `PermissionScreen` implementation (and standard permission logic) might leave the user in a "Granted" state if Coarse is granted but Fine is denied.
-   **Problem:** If the UI doesn't explicitly handle "Coarse Granted, Fine Denied" as a specific error state, the user might be stuck in a loop or progress with insufficient permissions.
-   **Resolution:** The `PermissionViewModel` logic must explicitly check `permissions[ACCESS_FINE_LOCATION] == true`. If only Coarse is granted, the state should remain in a "Pending" or "Error" state, and the UI must display a specific rationale explaining that "Precise Location" is required for the tracker to function.

### 3. Incomplete Service Stub Definition
The plan instructs to "Create TrackerService (Stub if missing)" with a `start()` helper.
-   **Problem:** A bare-bones stub service that doesn't call `startForeground` with a notification within a few seconds will crash on Android 12+ (Foreground Service start restrictions) or be killed by the system. This would fail the "Setup Trap" validation if the app crashes immediately upon entering the dashboard.
-   **Resolution:** The `TrackerService` stub must be a fully functional *Foreground Service* implementation. It must create a Notification Channel and call `startForeground` with a persistent notification in `onStartCommand`.

### 4. Ambiguity on Old Code Removal
The plan says "Refactor PermissionScreen" but does not explicitly instruct to remove the existing internal state logic (`determinePermissionStep`, `currentStep`, etc.) which is currently coupled inside the Composable.
-   **Problem:** Risk of leaving "zombie code" or conflicting logic where the Composable tries to manage state that the ViewModel should now own.
-   **Resolution:** Explicitly list the removal of the old `PermissionStep` enum (if replaced by ViewModel state), the `determinePermissionStep` function, and local state variables in the Composable.

### 5. Testing Naming Convention
The plan's testing step does not explicitly mention the project's strict naming convention for test functions.
-   **Problem:** New tests might be created using camelCase or underscores instead of the required backtick syntax (e.g., \`returns failure when...\`).
-   **Resolution:** Add a reminder to strictly follow the backtick naming convention in `PermissionViewModelTest.kt`.

### 6. Notification Permission Optionality
The plan correctly identifies `POST_NOTIFICATIONS` as optional, but the current `PermissionScreen` logic generally blocks progress if the "required" permission set isn't granted.
-   **Problem:** The logic must be robust enough to allow transition to the next step even if `POST_NOTIFICATIONS` is denied, distinguishing it from the mandatory Location permissions.
-   **Resolution:** Ensure `PermissionViewModel` logic treats `POST_NOTIFICATIONS` denial as a "success" (or non-blocking warning) for the purpose of state transition.

## Proposed Plan Updates

### Updated Step 3: Create PermissionViewModel.kt
-   **Refined Logic:**
    -   State: `PermissionUiState` (ForegroundPending, BackgroundPending, DeniedForever, Granted, **CoarseError**).
    -   Action: `updatePermissions(isFine: Boolean, isCoarse: Boolean, isBackground: Boolean, isNotifications: Boolean)`.
    -   **Constraint:** If `isCoarse == true` AND `isFine == false`, set state to `CoarseError`.
    -   **Constraint:** If `isNotifications == false`, proceed anyway.

### Updated Step 4: Update PermissionScreen.kt
-   **Refactor:** **Remove** `determinePermissionStep` and local `currentStep` state.
-   **Lifecycle:** On `ON_RESUME`, perform `ContextCompat.checkSelfPermission` for all keys and call `viewModel.updatePermissions(...)`.
-   **UI:** Add error text/dialog for `CoarseError` state ("Locus requires precise location to function").

### Updated Step 5: Create TrackerService.kt
-   **Requirement:** Must implement `onStartCommand` that calls `startForeground()` immediately with a valid `Notification` and `NotificationChannel`.
-   **Intent:** Must return `START_STICKY`.

### Updated Step 9: Create PermissionViewModelTest.kt
-   **Convention:** Use Kotlin backtick syntax for test names (e.g., \`fails when fine location is missing\`).
